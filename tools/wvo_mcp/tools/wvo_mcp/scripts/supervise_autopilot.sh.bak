#!/usr/bin/env bash
# Autopilot Supervisor - Monitors and restarts autopilot with safety limits
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
MEMORY_LIMIT_MB=2048
FD_LIMIT=1024
NICE_LEVEL=5
HEARTBEAT_TIMEOUT_SECONDS=90
STUCK_KILL_TIMEOUT_SECONDS=10
MAX_CRASHES=6
BACKOFF_RESET_RUNTIME=300

# Paths
WORKSPACE_ROOT="$(cd "$(dirname "$0")/../../.." && pwd)"
STATE_DIR="$WORKSPACE_ROOT/state"
HEARTBEAT_FILE="$STATE_DIR/heartbeat"
PID_FILE="$STATE_DIR/worker_pid"
SUPERVISOR_LOG="$STATE_DIR/supervisor.log"
AUTOPILOT_SCRIPT="$WORKSPACE_ROOT/tools/wvo_mcp/dist/src/orchestrator/autopilot_unified.js"

# State
CRASH_COUNT=0
LAST_START_TIME=0
AUTOPILOT_PID=""

log() {
  echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $*" | tee -a "$SUPERVISOR_LOG"
}

log_error() {
  echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR:${NC} $*" | tee -a "$SUPERVISOR_LOG"
}

log_warn() {
  echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARN:${NC} $*" | tee -a "$SUPERVISOR_LOG"
}

log_success() {
  echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] âœ“${NC} $*" | tee -a "$SUPERVISOR_LOG"
}

check_disk_space() {
  log "Checking disk space..."
  DISK_USAGE=$(df -h "$WORKSPACE_ROOT" | tail -1 | awk '{print $5}' | sed 's/%//')
  DISK_FREE_GB=$(df -h "$WORKSPACE_ROOT" | tail -1 | awk '{print $4}' | sed 's/Gi//')

  if [ "$DISK_USAGE" -ge 95 ]; then
    log_error "Disk usage critical: ${DISK_USAGE}% (shutdown threshold)"
    exit 100
  fi

  if [ "$DISK_USAGE" -ge 90 ]; then
    log_warn "Disk usage high: ${DISK_USAGE}% (free: ${DISK_FREE_GB}GB)"
  else
    log_success "Disk usage OK: ${DISK_USAGE}% (free: ${DISK_FREE_GB}GB)"
  fi
}

check_memory_available() {
  log "Checking available memory..."
  AVAILABLE_MB=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//' | awk '{print int($1 * 4096 / 1024 / 1024)}')

  if [ "$AVAILABLE_MB" -lt 1000 ]; then
    log_warn "Low available memory: ${AVAILABLE_MB}MB"
  else
    log_success "Available memory: ${AVAILABLE_MB}MB"
  fi
}

check_heartbeat() {
  if [ ! -f "$HEARTBEAT_FILE" ]; then
    return 1
  fi

  HEARTBEAT_TIME=$(cat "$HEARTBEAT_FILE")
  HEARTBEAT_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${HEARTBEAT_TIME:0:19}" "+%s" 2>/dev/null || echo "0")
  CURRENT_EPOCH=$(date +%s)
  AGE=$((CURRENT_EPOCH - HEARTBEAT_EPOCH))

  if [ "$AGE" -gt "$HEARTBEAT_TIMEOUT_SECONDS" ]; then
    log_error "Heartbeat stale: ${AGE}s old"
    return 1
  fi
  return 0
}

kill_autopilot_gracefully() {
  local PID=$1
  log "Shutting down autopilot (PID: $PID)..."

  if kill -TERM "$PID" 2>/dev/null; then
    sleep "$STUCK_KILL_TIMEOUT_SECONDS"
    if kill -0 "$PID" 2>/dev/null; then
      kill -KILL "$PID" 2>/dev/null || true
    fi
  fi

  pkill -KILL -P "$PID" 2>/dev/null || true
  log_success "Autopilot stopped"
}

calculate_backoff() {
  local count=$1
  local backoffs=(1 2 4 8 16)
  local max_index=$((${#backoffs[@]} - 1))
  
  if [ "$count" -gt "$max_index" ]; then
    echo "${backoffs[$max_index]}"
  else
    echo "${backoffs[$count]}"
  fi
}

should_restart() {
  local exit_code=$1

  if [ "$exit_code" -eq 0 ]; then
    log_success "Autopilot exited cleanly"
    return 1
  fi

  if [ "$exit_code" -ge 100 ] && [ "$exit_code" -lt 110 ]; then
    log_error "Fatal error (exit $exit_code)"
    return 1
  fi

  CRASH_COUNT=$((CRASH_COUNT + 1))
  if [ "$CRASH_COUNT" -gt "$MAX_CRASHES" ]; then
    log_error "Too many crashes ($CRASH_COUNT)"
    return 1
  fi

  log_warn "Crash #$CRASH_COUNT/$MAX_CRASHES (exit $exit_code)"
  return 0
}

cleanup() {
  log "Supervisor shutting down..."
  if [ -n "$AUTOPILOT_PID" ] && kill -0 "$AUTOPILOT_PID" 2>/dev/null; then
    kill_autopilot_gracefully "$AUTOPILOT_PID"
  fi
  pkill -f "autopilot_unified.js" 2>/dev/null || true
  log_success "Supervisor stopped"
  exit 0
}

trap cleanup SIGINT SIGTERM

log "=========================================="
log "Autopilot Supervisor Starting"
log "Memory: ${MEMORY_LIMIT_MB}MB | FD: ${FD_LIMIT} | Nice: ${NICE_LEVEL}"
log "=========================================="

while true; do
  check_disk_space
  check_memory_available

  CURRENT_TIME=$(date +%s)
  if [ "$LAST_START_TIME" -gt 0 ]; then
    RUNTIME=$((CURRENT_TIME - LAST_START_TIME))
    if [ "$RUNTIME" -gt "$BACKOFF_RESET_RUNTIME" ] && [ "$CRASH_COUNT" -gt 0 ]; then
      log "Resetting crash counter (stable for ${RUNTIME}s)"
      CRASH_COUNT=0
    fi
  fi
  LAST_START_TIME=$CURRENT_TIME

  if [ "$CRASH_COUNT" -gt 0 ]; then
    BACKOFF=$(calculate_backoff $((CRASH_COUNT - 1)))
    log "Backing off ${BACKOFF}s..."
    sleep "$BACKOFF"
  fi

  ulimit -n "$FD_LIMIT" 2>/dev/null || true
  ulimit -v $((MEMORY_LIMIT_MB * 1024)) 2>/dev/null || true

  log "Starting autopilot..."
  cd "$WORKSPACE_ROOT"

  nice -n "$NICE_LEVEL" node --max-old-space-size="$MEMORY_LIMIT_MB" "$AUTOPILOT_SCRIPT" &
  AUTOPILOT_PID=$!
  log_success "Autopilot started (PID: $AUTOPILOT_PID)"

  while kill -0 "$AUTOPILOT_PID" 2>/dev/null; do
    sleep 60
    if ! check_heartbeat; then
      log_error "Heartbeat failed, killing process..."
      kill_autopilot_gracefully "$AUTOPILOT_PID"
      break
    fi
  done

  wait "$AUTOPILOT_PID" || EXIT_CODE=$?

  if ! should_restart "$EXIT_CODE"; then
    break
  fi
done

log_success "Supervisor exiting"
