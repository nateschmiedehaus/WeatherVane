#!/bin/bash
# Pre-commit hook to prevent credential leaks
# Install with: git config core.hooksPath .githooks

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0

# Patterns to block (with exemptions for documentation/examples)
declare -a PATTERNS=(
    "sk-[A-Za-z0-9]{20,}"  # OpenAI key format (actual keys, not variables)
    "BEGIN RSA PRIVATE KEY"
    "BEGIN PRIVATE KEY"
    "BEGIN OPENSSH PRIVATE KEY"
    "-----END.*PRIVATE"
)

# File patterns to skip (documentation, examples, hooks)
SKIP_PATTERNS=(
    ".md$"
    ".example$"
    ".template$"
    ".githooks"
    "docs/"
    "credentials_manager"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

echo -e "${YELLOW}üîê Running credential leak detection...${NC}"

for file in $STAGED_FILES; do
    # Skip files that are documentation or examples
    SKIP=0
    for skip_pattern in "${SKIP_PATTERNS[@]}"; do
        if [[ "$file" =~ $skip_pattern ]]; then
            SKIP=1
            break
        fi
    done

    if [ $SKIP -eq 1 ]; then
        continue
    fi

    # Check against patterns (only in source code, not docs)
    for pattern in "${PATTERNS[@]}"; do
        if git diff --cached "$file" | grep -E "$pattern" > /dev/null; then
            echo -e "${RED}‚ùå BLOCKED: Potential credential in $file${NC}"
            echo "   Pattern: $pattern"
            ERRORS=$((ERRORS + 1))
        fi
    done

    # Block specific file extensions (these are credential stores)
    if [[ "$file" =~ auth\.json$ ]] || [[ "$file" =~ credentials\.json$ ]] || [[ "$file" =~ \.pem$ ]] || [[ "$file" =~ \.key$ ]] || [[ "$file" =~ \.p12$ ]] || [[ "$file" =~ \.pfx$ ]]; then
        echo -e "${RED}‚ùå BLOCKED: Credential file type in $file${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Commit blocked: Found $ERRORS potential credential leaks${NC}"
    echo ""
    echo "Guidelines:"
    echo "  1. Move credentials to .env (added to .gitignore)"
    echo "  2. Use environment variables instead"
    echo "  3. Use CredentialsManager for runtime loading"
    echo ""
    echo "To override (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}‚úÖ No credential leaks detected${NC}"
exit 0
