# Plan: AFP-ROADMAP-AUTONOMY-DOCSYNC-20251105

## Via Negativa Analysis

- **Docs/roadmap cleanup**: Delete legacy product-first framing instead of layering new sections on top. Keep only content that accelerates autonomy proof.  
- **Docsync scope**: Instead of adding more directories, shrink to curated allowlist and ignore everything else via `.docsyncignore`.  
- **Guardrails**: Reuse existing pre-commit infrastructure—augment rules rather than adding a new hook.  
- **Manifest analytics**: Extend existing `state/analytics/readme_manifest.json` rather than creating a new database.

Conclusion: This task is largely refactoring and deletion; additions are targeted (new ignore file, roadmap narrative, tests).

## Architecture & Approach

1. **Roadmap Wave System**
   - Create wave-based narrative (Wave 0–Wave 4) mapping to autonomy maturity.
   - Map each wave to epics/milestones in `state/roadmap.yaml`. Use YAML anchors/comments to keep maintainable.
   - Introduce terminal "Autonomy Proof Gauntlet" with cross-domain build tasks.

2. **Agent Governance Updates**
   - Update `AGENTS.md` (and other roadmap governance docs) with: wave-first execution rule, meta-task enforcement, README upkeep responsibilities.
   - Add guardrails playbook for when wave and backlog conflict.

3. **Docs Automation Hardening**
   - Introduce `.docsyncignore` to exclude caches/build outputs.  
   - Adjust `tools/docsync/analyzer.ts` to enforce curated roots/wave directories; add fail-fast when directory count > limit.  
   - Add invariant test (e.g., `tools/docsync/index.test.ts`) ensuring tracked directories stay below threshold.

4. **Knowledge Base Workflow**
   - Add roadmap tasks ensuring module template/index/diagrams/first-time guides delivered (per quick wins).  
   - Document workflow in `docs/README_AUTOMATION.md` & roadmap instructions.

## File-Level Plan

| File | Action | LOC (+/-) | Notes |
| --- | --- | --- | --- |
| `docs/ROADMAP.md` | Rewrite to wave framing | +? -? (net small) | Keep ≤150 LOC where possible via pruning. |
| `state/roadmap.yaml` | Re-sequence milestones/tasks | moderate | Focus on editing existing entries, avoid new duplicates. |
| `AGENTS.md` | Add wave execution rules, README governance | +?? | Keep concise. |
| `docs/orchestration/roadmap_intake.md` (or similar) | Update operational commands if required | low | Evaluate necessity. |
| `.docsyncignore` | New file | + | Document structure. |
| `tools/docsync/analyzer.ts` | Tighten filters + limit enforcement | moderate | Add tests to `tools/docsync/index.test.ts`. |
| `.githooks/pre-commit` | Add nuance for curated docsync operations (if needed) | low | Possibly 0 changes if already sufficient. |
| `docs/README_AUTOMATION.md` | Capture new policy & workflow | low | Append to existing doc. |
| `state/analytics/readme_manifest.json` | Regenerate with new scope | large but autogenerated | Ensure change is meaningful and within allowlist. |
| READMEs | Regenerate curated set | large | Use `ALLOW_DOCSYNC_BULK=1` gating once final diff is clean. |
| Evidence docs | Already being created | low | Maintain compliance. |

## Sequencing (Implementation Steps)

1. Finalise evidence documents (strategy/spec/plan/think/design).  
2. Refactor roadmap narrative + YAML (no code yet).  
3. Update agent governance docs.  
4. Implement docsync guardrail changes (`.docsyncignore`, analyzer updates, tests).  
5. Update documentation for docsync workflow & guardrail nuance.  
6. Run docsync to regenerate READMEs using new scope; inspect directory count; fix warnings.  
7. Update manifest and confirm `npm run readme:check` & targeted tests pass.  
8. Stage changes; if README count >5 files, use bulk override with justification.  
9. Record verifications in evidence (`verify.md`) post-tests.

## Risk & Mitigation

- **Risk: Net LOC >150** — Mitigate by pruning docs, emphasising deletion, summarising instead of duplicating.  
- **Risk: Roadmap YAML mistakes** — Use `yq` or TypeScript tooling? double-check with validation script.  
- **Risk: README generation still huge** — Test filters incrementally; add console output in docsync to show counts; adjust ignore file.  
- **Risk: Pre-commit protection regressions** — Run hook locally (e.g., `SKIP_AFP=1` if necessary) but ensure final design passes.  
- **Risk: Autonomy tasks ambiguous** — Provide precise exit criteria and dependencies.

## Metrics & Telemetry

- Track number of docsync directories via new test or CLI output.  
- Add TODO for autop-run coverage hooking into `state/analytics/readme_manifest.json`.  
- Ensure wave completion statuses recorded (maybe comment in YAML).  

## Dependencies & Assumptions

- Node/TypeScript environment available (`npm install` already done).  
- Agents will respect AGENTS.md updates once merged.  
- We can temporarily set `ALLOW_DOCSYNC_BULK=1` for final commit.  
- `tools/docsync/index.test.ts` exists and can be extended.

Assumptions to validate: docsync update script deterministic; autop guardrails not conflicting with modifications; no other tasks editing same docs concurrently.

## PLAN-authored Tests
- `npm --prefix tools/docsync run lint` — ensure updated analyzer and ignore files conform to standards.
- `npm --prefix tools/docsync run test` — extend unit tests verifying curated directory limits.
- `npm --prefix tools/wvo_mcp run test -- process` — confirm ProcessCritic enforces roadmap/doc expectations post-edit.
- Manual: `npx tsx tools/docsync/scripts/run_manifest_check.ts` (or equivalent) to validate manifest counts.
- Manual: `node tools/wvo_mcp/scripts/mcp_tool_cli.mjs plan_next '{"minimal":true}'` to ensure roadmap YAML edits parse correctly.
- Manual autopilot regression: `npm run wave0 -- --docsync-check` to validate roadmap/doc automation does not break Wave 0 planning.
