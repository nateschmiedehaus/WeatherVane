# Task Brief: Review context_assembler.ts

**Task ID**: AFP-GATE-TEST-REVIEW-CONTEXTASM-20251105

**Parent**: AFP-GATE-TEST-MACRO-20251105

**Complexity**: Medium

**Estimated Time**: 3-4 hours (including GATE)

---

## Objective

Review `tools/wvo_mcp/src/orchestrator/context_assembler.ts` for error handling gaps, type safety issues, and code duplication.

**Focus Areas:**
1. Silent error handling (lines 129-131, 952)
2. Unsafe metadata casts (line 278)
3. Duplicate task text computation (lines 543, 587)

---

## Findings from Exploration

**File**: `tools/wvo_mcp/src/orchestrator/context_assembler.ts`

**Size**: 1,154 LOC

**Issues Identified:**

### Issue 1: Silent Error Handling
**Locations**: Line 129-131, Line 952

**Line 129-131:**
```typescript
} catch {
  // Code search already logged the underlying rebuild failure; no-op here.
}
```

**Problem:** Comment assumes code search logged error. If it didn't, error is lost silently.

**Line 952:**
```typescript
return [];  // Swallows error during code search lookup
```

**Problem:** Makes debugging difficult. Caller doesn't know lookup failed.

**Impact:** Hidden failures make system unreliable

### Issue 2: Unsafe Metadata Cast
**Location**: Line 278

**Current Code:**
```typescript
isAutogenerated: Boolean(task.metadata && (task.metadata as Record<string, unknown>).autogenerated),
```

**Problem:**
- `task.metadata` type not verified before casting
- Runtime error if metadata is null/undefined/wrong shape
- No validation of `autogenerated` field

**Impact:** Potential crashes, unclear API contract

### Issue 3: Duplicate Task Text Computation
**Locations**: Lines 543 and 587

**Both compute:**
```typescript
const taskText = `${task.title} ${task.description || ''}`.toLowerCase();
```

**Problem:**
- Wasted computation (runs twice for same task)
- Potential drift if logic changes in one place but not the other
- Classic maintenance hazard

**Via Negativa:** Can we DELETE one by computing once and reusing?

---

## Expected Improvements

### Improvement 1: Explicit Error Handling
**Approach:**
- Add `logWarning()` calls with context
- Return error indicators instead of silent failures
- Document error handling strategy in comments

**Estimated LOC:** +15 (better error handling) = +15 net LOC

### Improvement 2: Safe Metadata Access
**Approach:**
- Create `TaskMetadata` interface
- Add validation function `validateTaskMetadata()`
- Replace unsafe casts with validated access
- Add tests for edge cases

**Estimated LOC:** +40 (interface + validation) +10 (usage) = +50 net LOC

### Improvement 3: Extract Repeated Computation
**Approach:**
- Create `private getTaskNormalizedText(task: Task): string`
- Compute once, reuse in both places
- Cache if task is evaluated multiple times

**Estimated LOC:** +10 (method) -5 (removed duplication) = +5 net LOC

**Total Estimated:** +70 net LOC

---

## Alternatives to Consider

### Alternative 1: Error Handling Only
- Fix silent errors, skip the rest
- Fastest path (~1-2 hours)
- **Trade-off:** Leaves type safety and duplication issues

### Alternative 2: All Three Improvements
- Comprehensive cleanup
- Most thorough (~3-4 hours)
- **Trade-off:** Approaches micro-batching limit

### Alternative 3: Types + Errors (Skip Duplication)
- Fix types and errors (higher priority)
- Leave duplication for later
- **Trade-off:** Less complete, but focused on safety

---

## Success Criteria

**Code Quality:**
- ✅ No silent error handling
- ✅ Type-safe metadata access
- ✅ No duplicate computations
- ✅ Tests pass, coverage maintained

**GATE Process:**
- ✅ Remediation cycles expected (1-2 rounds)
- ✅ Alternatives clearly justified
- ✅ Implementation matches design

**GATE Test Value:**
- This is medium complexity - perfect for testing remediation workflow
- Expect DesignReviewer to catch if alternatives aren't well-analyzed
- Tests whether feedback is actionable

---

## Deliverables

1. design.md (expect 120-150 LOC)
2. Code improvements
3. Tests for new validation logic
4. metrics.yaml
5. summary.md

---

**Start with GATE - this one should trigger remediation!**
