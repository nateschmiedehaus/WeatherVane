# Design Document: context_assembler.ts Error Handling & Safety Improvements

**Task**: AFP-GATE-TEST-REVIEW-CONTEXTASM-20251105
**Date**: 2025-11-05
**Complexity**: Medium (3-4 hours)

---

## Problem Statement

The `context_assembler.ts` file has three categories of issues:

1. **Silent error handling** (lines 129-131, 952-953) - Errors are swallowed without logging, making debugging impossible
2. **Unsafe metadata access** (line 278) - Unsafe cast without validation risks runtime crashes
3. **Code duplication** (lines 543, 587) - Task text computation repeated, maintenance hazard

These issues reduce reliability and maintainability of the context assembly system.

## Via Negativa Analysis

**Can we delete/simplify instead of adding?**
- **YES** for issue #3! We can DELETE one duplicate computation by extracting to a method
- **NO** for issues #1-2: We must ADD error handling and validation

**What complexity can we eliminate?**
- Eliminate duplicate computation (issue #3)
- Eliminate unsafe casts (replace with safe validation)
- Cannot eliminate error handling - must make it explicit

## Refactor vs Repair

**Is this a patch or a refactoring?**
- **Issue #1 (error handling)**: REPAIR - adding missing error logs
- **Issue #2 (type safety)**: REFACTOR - creating proper types and validation
- **Issue #3 (duplication)**: REFACTOR - extracting method to eliminate duplication

**Justification:**
- Silent errors are a bug (repair needed)
- Unsafe casts are technical debt (refactoring needed)
- Duplication violates DRY (refactoring via extraction)

## Alternatives Considered

### Alternative 1: Error Handling Only (Minimal)
**Scope:**
- Fix silent error handling (lines 129-131, 952-953)
- Skip metadata safety and duplication

**LOC estimate:** +15 LOC

**Pros:**
- Fastest implementation (~1-2 hours)
- Addresses most critical issue (debugging failures)

**Cons:**
- Leaves type safety gap (unsafe cast remains)
- Leaves maintenance hazard (duplication remains)

**Why rejected:** Doesn't address type safety, incomplete fix

### Alternative 2: All Three Improvements (CHOSEN)
**Scope:**
- Fix error handling
- Add metadata type safety
- Extract duplicate computation

**LOC estimate:** +70 LOC (+15 errors, +50 types, +5 extraction)

**Pros:**
- Comprehensive fix
- Well under 150 LOC limit
- Addresses all identified issues
- Good balance of safety and maintainability

**Cons:**
- Takes longer (~3-4 hours)

**Why chosen:** All three issues are important, total LOC is reasonable, comprehensive solution

### Alternative 3: Types + Errors (Skip Duplication)
**Scope:**
- Fix error handling
- Add metadata safety
- Leave duplication for later

**LOC estimate:** +65 LOC

**Pros:**
- Focuses on safety first
- Saves ~30 min

**Cons:**
- Leaves maintenance hazard
- Only saves 5 LOC

**Why rejected:** Duplication fix is cheap (+5 LOC) and valuable, worth including

## Complexity Analysis

**Does this increase or decrease complexity?**
- **Net DECREASE**
- Error handling improves debuggability
- Type safety prevents crashes
- Duplication removal improves maintainability

**LOC estimate:**
- Existing: 1,154 LOC
- Changes: +70 LOC
- Net: 1,224 LOC (+6%)

## Implementation Plan

### Files to Change
1. `tools/wvo_mcp/src/orchestrator/context_assembler.ts` (MODIFY)

### Specific Changes

**Change 1: Fix silent error in awaitIdle (line 129-131)**
```typescript
// BEFORE
try {
  await this.codeSearch.awaitIdle();
} catch {
  // Code search already logged the underlying rebuild failure; no-op here.
}

// AFTER
try {
  await this.codeSearch.awaitIdle();
} catch (error) {
  logWarning('Code search rebuild failed during context assembly', {
    error: error instanceof Error ? error.message : String(error),
  });
  // Continue - code search unavailable but context can still be assembled
}
```

**Change 2: Fix silent error in lookupRelevantFiles (line 952-953)**
```typescript
// BEFORE
} catch (error) {
  return [];
}

// AFTER
} catch (error) {
  logWarning('Code search lookup failed, returning empty results', {
    query: keywords.join(', '),
    error: error instanceof Error ? error.message : String(error),
  });
  return [];
}
```

**Change 3: Add TaskMetadata interface and validation**
```typescript
// ADD near top of file (after imports)
interface TaskMetadata {
  autogenerated?: boolean;
  // Add other known metadata fields as discovered
}

function isTaskMetadata(value: unknown): value is TaskMetadata {
  if (!value || typeof value !== 'object') return false;
  const obj = value as Record<string, unknown>;
  // autogenerated is optional boolean
  if ('autogenerated' in obj && typeof obj.autogenerated !== 'boolean') {
    return false;
  }
  return true;
}
```

**Change 4: Replace unsafe cast with validation (line 278)**
```typescript
// BEFORE
isAutogenerated: Boolean(task.metadata && (task.metadata as Record<string, unknown>).autogenerated),

// AFTER
isAutogenerated: isTaskMetadata(task.metadata) && Boolean(task.metadata.autogenerated),
```

**Change 5: Extract duplicate task text computation**
```typescript
// ADD new private method
/**
 * Get normalized lowercase text for task keyword matching
 */
private getTaskNormalizedText(task: Task): string {
  return `${task.title} ${task.description || ''}`.toLowerCase();
}

// REPLACE line 543
const taskText = this.getTaskNormalizedText(task);

// REPLACE line 587
const taskText = this.getTaskNormalizedText(task);
```

### Testing Plan
- Build verification: `npm run build`
- Test suite: `npm test` (should still have all 996 tests passing)
- Manual verification: Check that error logs appear in test output
- No new unit tests needed (existing tests cover these code paths)

### Risks
1. **Risk**: Error logging too noisy in normal operation
   - **Mitigation**: Use `logWarning` not `logError`, include context

2. **Risk**: TaskMetadata interface incomplete (missing fields)
   - **Mitigation**: Start with known field (autogenerated), add more as needed

3. **Risk**: Tests rely on silent error behavior
   - **Mitigation**: Run tests immediately, fix any failures

## Exit Criteria
- ✅ No silent catch blocks (all have logging)
- ✅ No unsafe metadata casts (validation used)
- ✅ No duplicate task text computation (extracted to method)
- ✅ npm run build completes with 0 errors
- ✅ All 996 tests pass
- ✅ LOC within limit (+70 vs +150 max)

## AFP/SCAS Compliance
- **Via negativa**: Eliminating duplicate computation (DRY principle)
- **Refactor not repair**: Mix - repairs silent errors, refactors type safety and duplication
- **Complexity**: Net decrease (better error messages, type safety, less duplication)
- **LOC constraint**: +70 LOC << +150 limit ✅
- **File constraint**: 1 file << 5 max ✅

## Notes
- This task addresses all three issue categories comprehensively
- Error handling is most critical (impacts debugging)
- Type safety prevents runtime crashes
- Duplication fix is cheap (+5 LOC) and valuable
- All three improvements together are still well under the LOC limit
